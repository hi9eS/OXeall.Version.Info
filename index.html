<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>OXeall Studios | CLNEWS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Официальная лента обновлений и новостей игр OXeall Studios." />
  <style>
    :root {
      --bg: #05070b;
      --bg-panel: #0b0f17;
      --bg-card: #0f141d;
      --accent: #1a9fff;
      --accent-soft: rgba(26,159,255,0.14);
      --accent-strong: #55c6ff;
      --text: #f5f7fb;
      --muted: #a5afc3;
      --border: #202736;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow: 0 18px 42px rgba(0,0,0,0.8);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --tr-fast: 0.18s ease-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-main);
      background:
        radial-gradient(circle at top, rgba(26,159,255,0.09), transparent 55%),
        #020308;
      color: var(--text);
      min-height: 100vh;
    }

    a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    /* HEADER */

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 18px;
      border-radius: var(--radius-lg);
      background: linear-gradient(
        135deg,
        rgba(26,159,255,0.16),
        rgba(3,5,10,0.98)
      );
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 30;
      backdrop-filter: blur(14px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: radial-gradient(circle at 25% 0, #ffffff, #1a9fff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #020308;
      box-shadow: 0 8px 20px rgba(0,0,0,0.9);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text span:first-child {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-strong);
    }

    .brand-text span:last-child {
      font-size: 12px;
      color: var(--muted);
    }

    nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      font-size: 10px;
      color: var(--muted);
    }

    .nav-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: default;
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.55);
    }

    .nav-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* TOP SECTION */

    .top {
      margin: 22px 2px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .top h1 {
      font-size: 24px;
      font-weight: 500;
    }

    .top p {
      font-size: 13px;
      color: var(--muted);
      max-width: 640px;
      line-height: 1.5;
    }

    .filters {
      margin-top: 6px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .select,
    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      box-shadow: 0 10px 26px rgba(0,0,0,0.85);
      font-size: 11px;
    }

    .select label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .select select {
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 11px;
      outline: none;
      cursor: pointer;
    }

    .search input {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 11px;
      min-width: 160px;
    }

    .tag {
      font-size: 9px;
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid rgba(26,159,255,0.4);
      background: var(--accent-soft);
      color: var(--accent-strong);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* FEATURED */

    .featured {
      margin-top: 14px;
      margin-bottom: 10px;
    }

    .featured-box {
      padding: 14px 14px 10px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .featured-box.empty {
      border-style: dashed;
      color: var(--muted);
      opacity: 0.85;
    }

    .featured-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-strong);
    }

    .featured-title {
      font-size: 15px;
      font-weight: 500;
    }

    .featured-sub {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .featured-meta {
      font-size: 9px;
      color: var(--muted);
    }

    /* LIST HEADER */

    .list-header {
      margin: 16px 2px 8px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      font-size: 10px;
      color: var(--muted);
    }

    .list-header strong {
      color: var(--accent-strong);
      font-weight: 500;
      font-size: 11px;
    }

    /* CARDS */

    .announcements {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .empty-state {
      font-size: 11px;
      color: var(--muted);
      padding: 12px 12px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(255,255,255,0.22);
      background: rgba(4,7,12,0.96);
      margin-top: 4px;
    }

    .card {
      padding: 12px 14px 10px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: 0 14px 36px rgba(0,0,0,0.9);
      display: grid;
      grid-template-columns: 1.7fr 1fr auto;
      column-gap: 14px;
      row-gap: 6px;
      align-items: flex-start;
      cursor: pointer;
      transition: all var(--tr-fast);
      position: relative;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 20px 52px rgba(0,0,0,1);
      transform: translateY(-2px);
    }

    .card-header-line {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 10px;
      color: var(--muted);
      grid-column: 1 / 3;
    }

    .badge-type {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid rgba(26,159,255,0.5);
    }

    .badge-game {
      font-size: 10px;
      color: var(--accent-strong);
    }

    .badge-version {
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--muted);
    }

    .badge-date {
      font-size: 9px;
      color: var(--muted);
    }

    .card-title {
      font-size: 15px;
      font-weight: 500;
      grid-column: 1 / 3;
    }

    .card-short {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      grid-column: 1 / 3;
    }

    .card-tags {
      grid-column: 1 / 3;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .card-tag {
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(2,4,8,0.98);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--muted);
    }

    .card-changelog {
      grid-column: 1 / 4;
      display: none;
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.08);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    .card-changelog ul {
      margin-left: 16px;
      margin-top: 4px;
    }

    .card-arrow {
      font-size: 10px;
      color: var(--muted);
      align-self: flex-start;
      margin-top: 2px;
      transition: transform var(--tr-fast), color var(--tr-fast);
    }

    .card.open .card-changelog {
      display: block;
    }

    .card.open .card-arrow {
      transform: rotate(180deg);
      color: var(--accent-strong);
    }

    /* ADMIN BUTTON */

    .admin-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 9px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(85,198,255,0.9), #05070b);
      border: 1px solid rgba(85,198,255,0.8);
      color: var(--text);
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      box-shadow: 0 18px 52px rgba(0,0,0,1);
      z-index: 80;
      transition: all var(--tr-fast);
    }

    .admin-btn span.icon {
      font-size: 13px;
    }

    .admin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 26px 70px rgba(0,0,0,1);
    }

    /* MODALS */

    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 90;
    }

    .modal-login {
      background: var(--bg-panel);
      padding: 16px 16px 12px;
      border-radius: var(--radius-lg);
      box-shadow: 0 26px 80px rgba(0,0,0,1);
      border: 1px solid rgba(255,255,255,0.08);
      max-width: 360px;
      width: 100%;
      font-size: 11px;
    }

    .modal-login h2 {
      font-size: 15px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .modal-login p {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .modal-login label {
      display: block;
      font-size: 9px;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .modal-login input {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #05070c;
      color: var(--text);
      font-size: 11px;
      outline: none;
      margin-bottom: 6px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      padding: 6px 11px;
      border-radius: 999px;
      border: none;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: all var(--tr-fast);
    }

    .btn-primary {
      background: var(--accent);
      color: #020308;
      font-weight: 600;
      box-shadow: 0 10px 26px rgba(0,0,0,0.95);
    }

    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: transparent;
      color: #ff4a6a;
      border: 1px solid rgba(255,74,106,0.6);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(0,0,0,1);
    }

    /* ADMIN PANEL */

    .modal-admin {
      background: var(--bg-panel);
      padding: 14px;
      border-radius: 20px;
      box-shadow: 0 30px 88px rgba(0,0,0,1);
      border: 1px solid rgba(85,198,255,0.32);
      max-width: 980px;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(260px, 1.2fr);
      gap: 14px;
      font-size: 10px;
    }

    .admin-headline {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .admin-headline h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-strong);
      font-weight: 500;
    }

    .admin-headline span {
      font-size: 9px;
      color: var(--muted);
    }

    .field-block {
      margin-bottom: 6px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .field-label {
      font-size: 8px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .field-input,
    .field-select,
    .field-textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #05070c;
      color: var(--text);
      font-size: 10px;
      outline: none;
      resize: vertical;
    }

    .field-textarea {
      min-height: 60px;
    }

    #fieldChangelog {
      min-height: 140px; /* больше changelog */
      line-height: 1.5;
    }

    .admin-actions {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* PREVIEW */

    .preview-label {
      font-size: 8px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .preview-card {
      margin-top: 4px;
      padding: 10px 11px 8px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
      display: grid;
      grid-template-columns: 1.7fr 1fr auto;
      column-gap: 10px;
      row-gap: 4px;
      font-size: 9px;
    }

    .preview-title {
      font-size: 12px;
      font-weight: 500;
      grid-column: 1 / 3;
    }

    .preview-short {
      font-size: 10px;
      color: var(--text);
      grid-column: 1 / 3;
    }

    .preview-date {
      font-size: 8px;
      color: var(--muted);
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: flex-end;
    }

    .preview-date span {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(26,159,255,0.4);
      color: var(--accent-strong);
      font-size: 7px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .preview-changelog {
      grid-column: 1 / 4;
      font-size: 9px;
      color: var(--muted);
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .admin-note {
      margin-top: 6px;
      font-size: 8px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* RESPONSIVE */

    @media (max-width: 860px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .modal-admin {
        grid-template-columns: 1fr;
        max-height: 92vh;
        overflow-y: auto;
      }
      .preview-card,
      .card {
        grid-template-columns: 1fr auto;
      }
      .card-header-line,
      .card-title,
      .card-short,
      .card-tags,
      .card-changelog {
        grid-column: 1 / 3;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="brand">
      <div class="brand-logo">OX</div>
      <div class="brand-text">
        <span>OXEALL STUDIOS CLNEWS</span>
        <span>Официальная лента обновлений игр OXeall</span>
      </div>
    </div>
    <nav>
      <div class="nav-pill"><span class="dot"></span>Обновления</div>
      <div class="nav-pill">Только официальный контент</div>
    </nav>
  </header>

  <section class="top">
    <h1>Лента обновлений OXeall Studios</h1>
    <p>
      Здесь публикуются официальные патч-ноуты, хотфиксы, крупные обновления, технические объявления и dev-логи
      по всем проектам OXeall Studios. Структура и подача — в духе Steam News.
    </p>
    <div class="filters">
      <div class="select">
        <label for="gameFilter">Игра</label>
        <select id="gameFilter">
          <option value="all">Все проекты</option>
        </select>
      </div>
      <div class="search">
        <input type="text" id="searchInput" placeholder="Поиск по заголовкам и изменениям..." />
      </div>
      <div class="tag">Developer Verified • OXeall</div>
    </div>
  </section>

  <section class="featured">
    <div class="featured-box empty" id="featuredBox">
      <div class="featured-label">Закреплённое обновление не выбрано</div>
      <div class="featured-sub">
        Любое обновление можно сделать <b>Featured</b> через панель разработчика — оно появится здесь
        как главное официальное объявление.
      </div>
    </div>
  </section>

  <div class="list-header">
    <div><strong>Все обновления</strong></div>
    <div>Клик по карточке — открыть / скрыть подробный changelog.</div>
  </div>

  <div id="emptyState" class="empty-state">
    Пока нет опубликованных обновлений. Используй кнопку <b>Admin Update Panel</b> в правом нижнем углу,
    чтобы добавить первое официальное объявление.
  </div>

  <section id="announcementList" class="announcements"></section>

  <footer style="margin-top:22px;font-size:9px;color:var(--muted);display:flex;justify-content:space-between;gap:8px;border-top:1px solid rgba(255,255,255,0.06);padding-top:8px;">
    <div>© <span id="year"></span> OXeall Studios. CLNEWS.</div>
    <div>Страница на GitHub Pages. Управление контентом — через Admin Update Panel.</div>
  </footer>
</div>

<!-- Admin button -->
<button class="admin-btn" id="adminBtn">
  <span class="icon">⚙️</span>
  <span>Admin Update Panel</span>
</button>

<!-- Login modal -->
<div class="backdrop" id="loginBackdrop">
  <div class="modal-login">
    <h2>Вход в панель разработчика</h2>
    <p>Доступ только для OXeall Studios. Введите пароль для управления лентой обновлений.</p>
    <label for="adminPassword">Пароль</label>
    <input type="password" id="adminPassword" placeholder="Введите пароль" />
    <div id="loginError" style="display:none;color:#ff4a6a;font-size:8px;margin-bottom:4px;">Неверный пароль.</div>
    <div class="modal-actions">
      <button class="btn btn-outline" id="loginCancel">Отмена</button>
      <button class="btn btn-primary" id="loginSubmit">Войти</button>
    </div>
  </div>
</div>

<!-- Admin panel modal -->
<div class="backdrop" id="adminBackdrop">
  <div class="modal-admin">
    <!-- LEFT: FORM -->
    <div>
      <div class="admin-headline">
        <h2>Admin Update Panel</h2>
        <span>Создание официальных обновлений в один шаг.</span>
      </div>

      <div class="field-block">
        <div class="field-label">Игра / Проект</div>
        <input id="fieldGame" class="field-input" type="text" placeholder="Например: CityPort, Neon Arena..." />
      </div>

      <div class="field-block" style="display:grid;grid-template-columns:1.4fr 1fr 1fr;gap:6px;">
        <div>
          <div class="field-label">Тип обновления</div>
          <select id="fieldType" class="field-select">
            <option value="Major">Major Update</option>
            <option value="Minor">Minor Update</option>
            <option value="Patch">Patch</option>
            <option value="Hotfix">Hotfix</option>
            <option value="Announcement">Announcement</option>
            <option value="DevLog">DevLog</option>
          </select>
        </div>
        <div>
          <div class="field-label">Версия</div>
          <input id="fieldVersion" class="field-input" type="text" placeholder="1.0.0 / 1.3.6f1..." />
        </div>
        <div>
          <div class="field-label">Дата</div>
          <input id="fieldDate" class="field-input" type="date" />
        </div>
      </div>

      <div class="field-block">
        <div class="field-label">Заголовок обновления</div>
        <input id="fieldTitle" class="field-input" type="text" placeholder="Официальный заголовок, как в Steam" />
      </div>

      <div class="field-block">
        <div class="field-label">Краткое описание (overview)</div>
        <textarea id="fieldShort" class="field-textarea" placeholder="2–4 строки: что изменилось, для кого, ключевые моменты."></textarea>
      </div>

      <div class="field-block">
        <div class="field-label">Полный changelog</div>
        <textarea id="fieldChangelog" class="field-textarea" placeholder="- Пункт 1
- Пункт 2
- Пункт 3"></textarea>
      </div>

      <div class="field-block" style="display:grid;grid-template-columns:1.6fr 1.4fr;gap:6px;">
        <div>
          <div class="field-label">Фоновое изображение (опционально, URL)</div>
          <input id="fieldBg" class="field-input" type="text" placeholder="Картинка для карточки / баннера" />
        </div>
        <div>
          <div class="field-label">Теги (через запятую)</div>
          <input id="fieldTags" class="field-input" type="text" placeholder="CityPort, Patch, Balance..." />
        </div>
      </div>

      <div class="field-block" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <label style="font-size:9px;color:var(--muted);display:flex;align-items:center;gap:4px;cursor:pointer;">
          <input type="checkbox" id="fieldFeatured" style="margin:0;" />
          Сделать это обновление Featured (верхний баннер)
        </label>
        <label style="font-size:9px;color:var(--muted);display:flex;align-items:center;gap:4px;cursor:pointer;">
          <input type="checkbox" id="fieldPin" style="margin:0;" />
          Закрепить вверху списка
        </label>
      </div>

      <div class="admin-actions">
        <button class="btn btn-primary" id="btnAddUpdate">Опубликовать обновление</button>
        <button class="btn btn-outline" id="btnClearForm">Очистить форму</button>
        <button class="btn btn-danger" id="btnClearLocal">Сбросить локальные обновления</button>
        <button class="btn btn-outline" id="btnClosePanel">Закрыть панель</button>
      </div>

      <div class="admin-note">
        Обновления сохраняются в этом браузере (localStorage), чтобы тебе было удобно редактировать структуру.
        Если захочешь, позже можно вынести их в статичный HTML или JSON для всех.
      </div>
    </div>

    <!-- RIGHT: PREVIEW -->
    <div>
      <div class="admin-headline">
        <h2>Предпросмотр</h2>
        <span>Так игроки увидят объявление на сайте.</span>
      </div>

      <div>
        <div class="preview-label" id="previewType">MAJOR UPDATE</div>
        <div class="preview-card">
          <div class="preview-title" id="previewTitle">Заголовок обновления</div>
          <div class="preview-short" id="previewShort">Краткое официальное описание появится здесь.</div>
          <div class="preview-date">
            <div id="previewGame">Проект</div>
            <span id="previewVersion">vX.X.X</span>
          </div>
          <div class="preview-changelog" id="previewChangelog">
            Список изменений (changelog) будет отображён в структурированном виде.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const ADMIN_PASSWORD = "OXS11993384756281";
  const STORAGE_KEY = "oxeall_clnews_updates_v2";

  document.getElementById("year").textContent = new Date().getFullYear();

  let isAdmin = false;
  let updates = [];

  /* Utils */

  function formatDate(str) {
    if (!str) return "";
    const d = new Date(str);
    if (isNaN(d)) return str;
    const months = ["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"];
    const dd = String(d.getDate()).padStart(2, "0");
    return `${dd} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function typeLabel(t) {
    switch (t) {
      case "Major": return "MAJOR UPDATE";
      case "Minor": return "MINOR UPDATE";
      case "Patch": return "PATCH";
      case "Hotfix": return "HOTFIX";
      case "Announcement": return "ANNOUNCEMENT";
      case "DevLog": return "DEVLOG";
      default: return "UPDATE";
    }
  }

  function changelogToHtml(text) {
    if (!text) return "";
    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
    if (!lines.length) return "";
    if (lines.every(l => l.startsWith("-") || l.startsWith("•"))) {
      return "<ul>" + lines.map(l => "<li>" + l.replace(/^(-|•)\s*/, "") + "</li>").join("") + "</ul>";
    }
    return text.replace(/\n/g, "<br>");
  }

  function saveLocal() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(updates));
    } catch (e) {}
  }

  function loadLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (Array.isArray(data)) updates = data;
    } catch (e) {}
  }

  function renderFeatured() {
    const box = document.getElementById("featuredBox");
    const feat = updates.find(u => u.featured);
    if (!feat) {
      box.classList.add("empty");
      box.style.backgroundImage = "none";
      box.innerHTML = `
        <div class="featured-label">Закреплённое обновление не выбрано</div>
        <div class="featured-sub">
          Отметь любое обновление как <b>Featured</b> в Admin Update Panel — оно появится здесь как главный баннер.
        </div>`;
      return;
    }
    box.classList.remove("empty");
    box.style.backgroundImage = feat.background
      ? `linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0.98)), url('${feat.background}')`
      : "none";
    box.style.backgroundSize = feat.background ? "cover" : "";
    box.style.backgroundPosition = feat.background ? "center" : "";
    box.innerHTML = `
      <div class="featured-label">${typeLabel(feat.type)} • ${feat.game}</div>
      <div class="featured-title">${feat.title}</div>
      <div class="featured-sub">${feat.short || ""}</div>
      <div class="featured-meta">
        ${formatDate(feat.date)} · Версия: ${feat.version || "—"}
        ${feat.tags && feat.tags.length ? " · " + feat.tags.join(", ") : ""}
      </div>`;
  }

  function renderUpdates() {
    const list = document.getElementById("announcementList");
    const empty = document.getElementById("emptyState");
    list.innerHTML = "";

    if (!updates.length) {
      empty.style.display = "block";
      renderFeatured();
      return;
    }
    empty.style.display = "none";

    // сортировка: pin -> дата (новее выше)
    updates.sort((a,b) => {
      if (a.pin && !b.pin) return -1;
      if (!a.pin && b.pin) return 1;
      const da = new Date(a.date || 0).getTime();
      const db = new Date(b.date || 0).getTime();
      return db - da;
    });

    updates.forEach((u, idx) => {
      const card = document.createElement("article");
      card.className = "card";
      card.dataset.game = u.game || "";
      card.dataset.search = (u.title + " " + (u.short||"") + " " + (u.changelog||"") + " " + (u.tags||[]).join(" ")).toLowerCase();

      const headerLine = document.createElement("div");
      headerLine.className = "card-header-line";

      const typeSpan = document.createElement("div");
      typeSpan.className = "badge-type";
      typeSpan.textContent = typeLabel(u.type);

      const gameSpan = document.createElement("div");
      gameSpan.className = "badge-game";
      gameSpan.textContent = u.game || "OXeall Project";

      const verSpan = document.createElement("div");
      verSpan.className = "badge-version";
      verSpan.textContent = u.version ? "v" + u.version : "без версии";

      const dateSpan = document.createElement("div");
      dateSpan.className = "badge-date";
      dateSpan.textContent = formatDate(u.date);

      headerLine.appendChild(typeSpan);
      headerLine.appendChild(gameSpan);
      headerLine.appendChild(verSpan);
      headerLine.appendChild(dateSpan);

      const titleDiv = document.createElement("div");
      titleDiv.className = "card-title";
      titleDiv.textContent = u.title || "Без названия";

      const shortDiv = document.createElement("div");
      shortDiv.className = "card-short";
      shortDiv.textContent = u.short || "";

      const tagsDiv = document.createElement("div");
      tagsDiv.className = "card-tags";
      (u.tags || []).forEach(t => {
        const el = document.createElement("div");
        el.className = "card-tag";
        el.textContent = t;
        tagsDiv.appendChild(el);
      });

      const arrow = document.createElement("div");
      arrow.className = "card-arrow";
      arrow.textContent = "▼";

      const changelogDiv = document.createElement("div");
      changelogDiv.className = "card-changelog";
      changelogDiv.innerHTML = changelogToHtml(u.changelog || "");

      if (u.background) {
        card.style.backgroundImage =
          `linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.98)), url('${u.background}')`;
        card.style.backgroundSize = "cover";
        card.style.backgroundPosition = "center";
      }

      card.appendChild(headerLine);
      card.appendChild(titleDiv);
      if (u.short) card.appendChild(shortDiv);
      if (u.tags && u.tags.length) card.appendChild(tagsDiv);
      card.appendChild(arrow);
      if (u.changelog) card.appendChild(changelogDiv);

      card.addEventListener("click", (e) => {
        if (e.target.tagName === "A" || e.target.closest("a")) return;
        card.classList.toggle("open");
      });

      list.appendChild(card);
    });

    renderFeatured();
    attachFilters();
  }

  function attachFilters() {
    const gameSelect = document.getElementById("gameFilter");
    const searchInput = document.getElementById("searchInput");
    const cards = Array.from(document.querySelectorAll(".card"));

    // заполнить список игр
    const games = Array.from(new Set(updates.map(u => u.game).filter(Boolean)));
    gameSelect.innerHTML = '<option value="all">Все проекты</option>' +
      games.map(g => `<option value="${g}">${g}</option>`).join("");

    function apply() {
      const g = gameSelect.value;
      const q = (searchInput.value || "").toLowerCase().trim();

      cards.forEach(c => {
        const matchGame = (g === "all") || (c.dataset.game === g);
        const matchSearch = !q || c.dataset.search.includes(q);
        c.style.display = (matchGame && matchSearch) ? "" : "none";
      });
    }

    gameSelect.onchange = apply;
    searchInput.oninput = apply;
    apply();
  }

  /* Load initial */

  loadLocal();
  renderUpdates();

  /* Admin button + login */

  const adminBtn = document.getElementById("adminBtn");
  const loginBackdrop = document.getElementById("loginBackdrop");
  const adminBackdrop = document.getElementById("adminBackdrop");
  const loginCancel = document.getElementById("loginCancel");
  const loginSubmit = document.getElementById("loginSubmit");
  const loginInput = document.getElementById("adminPassword");
  const loginError = document.getElementById("loginError");

  adminBtn.addEventListener("click", () => {
    if (isAdmin) {
      adminBackdrop.style.display = "flex";
      return;
    }
    loginError.style.display = "none";
    loginInput.value = "";
    loginBackdrop.style.display = "flex";
    loginInput.focus();
  });

  loginCancel.addEventListener("click", () => {
    loginBackdrop.style.display = "none";
  });

  loginSubmit.addEventListener("click", () => {
    const val = loginInput.value.trim();
    if (val === ADMIN_PASSWORD) {
      isAdmin = true;
      loginBackdrop.style.display = "none";
      adminBackdrop.style.display = "flex";
      loginError.style.display = "none";
    } else {
      loginError.style.display = "block";
    }
  });

  loginInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loginSubmit.click();
  });

  // Закрытие модалок по клику вне
  loginBackdrop.addEventListener("click", (e) => {
    if (e.target === loginBackdrop) loginBackdrop.style.display = "none";
  });
  adminBackdrop.addEventListener("click", (e) => {
    if (e.target === adminBackdrop) adminBackdrop.style.display = "none";
  });

  document.getElementById("btnClosePanel").addEventListener("click", () => {
    adminBackdrop.style.display = "none";
  });

  /* Admin form + preview */

  const fieldGame = document.getElementById("fieldGame");
  const fieldType = document.getElementById("fieldType");
  const fieldVersion = document.getElementById("fieldVersion");
  const fieldDate = document.getElementById("fieldDate");
  const fieldTitle = document.getElementById("fieldTitle");
  const fieldShort = document.getElementById("fieldShort");
  const fieldChangelog = document.getElementById("fieldChangelog");
  const fieldBg = document.getElementById("fieldBg");
  const fieldTags = document.getElementById("fieldTags");
  const fieldFeatured = document.getElementById("fieldFeatured");
  const fieldPin = document.getElementById("fieldPin");

  const previewType = document.getElementById("previewType");
  const previewTitle = document.getElementById("previewTitle");
  const previewShort = document.getElementById("previewShort");
  const previewGame = document.getElementById("previewGame");
  const previewVersion = document.getElementById("previewVersion");
  const previewChangelog = document.getElementById("previewChangelog");

  function updatePreview() {
    previewType.textContent = typeLabel(fieldType.value);
    previewTitle.textContent = fieldTitle.value || "Заголовок обновления";
    previewShort.textContent = fieldShort.value || "Краткое официальное описание обновления.";
    previewGame.textContent = fieldGame.value || "Проект";
    previewVersion.textContent = fieldVersion.value ? "v" + fieldVersion.value : "vX.X.X";

    const cl = fieldChangelog.value.trim();
    previewChangelog.innerHTML = cl
      ? changelogToHtml(cl)
      : "Список изменений (changelog) будет отображён здесь в структурированном виде.";

  }

  [
    fieldGame, fieldType, fieldVersion, fieldDate, fieldTitle,
    fieldShort, fieldChangelog, fieldBg, fieldTags,
    fieldFeatured, fieldPin
  ].forEach(el => el.addEventListener("input", updatePreview));

  updatePreview();

  document.getElementById("btnClearForm").addEventListener("click", () => {
    fieldGame.value = "";
    fieldType.value = "Major";
    fieldVersion.value = "";
    fieldDate.value = "";
    fieldTitle.value = "";
    fieldShort.value = "";
    fieldChangelog.value = "";
    fieldBg.value = "";
    fieldTags.value = "";
    fieldFeatured.checked = false;
    fieldPin.checked = false;
    updatePreview();
  });

  document.getElementById("btnClearLocal").addEventListener("click", () => {
    if (!confirm("Точно удалить все локально сохранённые обновления?")) return;
    localStorage.removeItem(STORAGE_KEY);
    updates = [];
    renderUpdates();
  });

  document.getElementById("btnAddUpdate").addEventListener("click", () => {
    const nowISO = new Date().toISOString().slice(0,10);
    const upd = {
      game: (fieldGame.value || "OXeall Project").trim(),
      type: fieldType.value,
      version: fieldVersion.value.trim(),
      date: fieldDate.value || nowISO,
      title: fieldTitle.value.trim() || "Без названия",
      short: fieldShort.value.trim(),
      changelog: fieldChangelog.value.trim(),
      background: fieldBg.value.trim(),
      tags: (fieldTags.value || "").split(",").map(t => t.trim()).filter(Boolean),
      featured: fieldFeatured.checked,
      pin: fieldPin.checked
    };

    if (upd.featured) {
      updates.forEach(u => u.featured = false);
    }

    updates.unshift(upd);
    saveLocal();
    renderUpdates();
    alert("Обновление добавлено в ленту (сохранено локально в этом браузере).");
  });
</script>
</body>
</html>
